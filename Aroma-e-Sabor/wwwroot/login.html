<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - Aroma e Sabor</title>
    <link rel="stylesheet" href="css/style.css" />
</head>

<body class="login-page">

    <div class="logo-banner">
        <h1><span class="aroma">AROMA</span> <br> <span class="e">E</span> <br> <span class="sabor">SABOR</span></h1>
    </div>

    <div class="login-box">
        <form id="loginForm" autocomplete="on">
            <input type="email" placeholder="Email" class="input-field" id="loginEmail" required />
            <input type="password" placeholder="Senha" class="input-field" id="loginSenha" required />

            <div class="options">
                <label><input type="checkbox" /> Lembre-se</label>
                <a href="esqueci.html">Esqueceu a senha?</a>
            </div>

            <button id="btnLogin" class="btn-primary" type="button">Acessar</button>


        </form>
        <p class="register-link">
            Não tem uma conta? <a href="cadastro.html">Crie uma conta</a>
        </p>
    </div>


    <script src="js/perfil.js"></script>
    <script>

        // Botão acessar só envia se login for válido
        document.getElementById('btnLogin').addEventListener('click', function () {
            var email = document.getElementById('loginEmail').value.trim();
            var senha = document.getElementById('loginSenha').value;
            var erroMsg = document.getElementById('erroMsg');
            if (!erroMsg) {
                erroMsg = document.createElement('div');
                erroMsg.id = 'erroMsg';
                erroMsg.style.color = 'red';
                erroMsg.style.marginBottom = '10px';
                document.getElementById('loginForm').insertBefore(erroMsg, document.getElementById('btnLogin'));
            }
            erroMsg.style.display = 'none';
            erroMsg.innerText = '';
            if (!email || !senha) {
                erroMsg.innerText = 'Preencha o email e a senha.';
                erroMsg.style.display = 'block';
                return;
            }
            fetch('/api/usuarios/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, senha }) // NÃO envie nome aqui!
            })
                .then(async resp => {
                    if (resp.ok) {
                        const data = await resp.json();
                        setUsuarioLogado(data.nome || data.email.split('@')[0] || 'Usuário');
                        localStorage.setItem('usuarioId', data.id); // Salva o id do usuário logado
                        localStorage.setItem('visitante', 'false');
                        if (data.fotoPerfil) localStorage.setItem('fotoPerfil', data.fotoPerfil);
                        window.location.href = 'home.html';
                    } else {
                        localStorage.setItem('visitante', 'false');
                        const msg = await resp.text();
                        erroMsg.innerText = msg || 'Email ou senha inválidos.';
                        erroMsg.style.display = 'block';
                    }
                })
                .catch(() => {
                    localStorage.setItem('visitante', 'false');
                    erroMsg.innerText = 'Erro ao conectar com o servidor.';
                    erroMsg.style.display = 'block';
                });
        });

        // (Lógica de visitante removida)
    </script>
</body>

</html>